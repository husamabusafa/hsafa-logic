generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "linux-musl-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// =============================================================================
// ENUMS
// =============================================================================

enum EntityType {
  human
  agent
  system
}

enum RunStatus {
  queued
  running
  waiting_tool
  completed
  failed
  canceled
}

enum ToolExecutionTarget {
  server
  client
  external
}

enum ToolCallStatus {
  requested
  dispatched
  completed
  failed
  expired
}

enum ToolResultSource {
  server
  client
}

enum PlanStatus {
  active
  paused
  completed
  canceled
}

// =============================================================================
// ENTITY - Unified identity (Human, Agent, System)
// =============================================================================

model Entity {
  id          String     @id @default(uuid()) @db.Uuid
  type        EntityType
  externalId  String?    @unique @map("external_id") // Your app's user ID, or agent name, or system key
  displayName String?    @map("display_name")
  metadata    Json?      @db.JsonB
  createdAt   DateTime   @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt   DateTime   @updatedAt @map("updated_at") @db.Timestamptz(6)

  // For Agent Entities - link to agent config
  agentId String? @unique @map("agent_id") @db.Uuid
  agent   Agent?  @relation(fields: [agentId], references: [id])

  // Relationships
  nexusMemberships NexusMembership[]
  messages         NexusMessage[]
  runs             Run[]              // Runs triggered by this entity
  clients          Client[]
  memories         Memory[]
  plans            Plan[]
  goals            Goal[]

  @@index([type])
  @@index([externalId])
  @@map("entities")
}

// =============================================================================
// NEXUS - Shared context space (timeline of events/messages)
// =============================================================================

model Nexus {
  id          String   @id @default(uuid()) @db.Uuid
  name        String?
  description String?
  isPrivate   Boolean  @default(false) @map("is_private")
  metadata    Json?    @db.JsonB
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt   DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  memberships NexusMembership[]
  messages    NexusMessage[]
  runs        Run[]

  @@index([createdAt])
  @@map("nexuses")
}

model NexusMembership {
  id        String   @id @default(uuid()) @db.Uuid
  nexusId   String   @map("nexus_id") @db.Uuid
  entityId  String   @map("entity_id") @db.Uuid
  role      String?  // optional: admin, member, observer, etc.
  joinedAt  DateTime @default(now()) @map("joined_at") @db.Timestamptz(6)

  nexus  Nexus  @relation(fields: [nexusId], references: [id], onDelete: Cascade)
  entity Entity @relation(fields: [entityId], references: [id], onDelete: Cascade)

  @@unique([nexusId, entityId])
  @@index([entityId])
  @@map("nexus_memberships")
}

// =============================================================================
// NEXUS TIMELINE - Messages/events in a Nexus
// =============================================================================

model NexusMessage {
  id        String   @id @default(uuid()) @db.Uuid
  nexusId   String   @map("nexus_id") @db.Uuid
  entityId  String   @map("entity_id") @db.Uuid
  role      String   // user, assistant, system, tool
  content   String?  @db.Text
  metadata  Json?    @db.JsonB
  seq       BigInt   // ordering within nexus
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  nexus  Nexus  @relation(fields: [nexusId], references: [id], onDelete: Cascade)
  entity Entity @relation(fields: [entityId], references: [id])

  // If this message was produced by a Run
  runId String? @map("run_id") @db.Uuid
  run   Run?    @relation(fields: [runId], references: [id])

  @@unique([nexusId, seq])
  @@index([nexusId, createdAt])
  @@index([entityId])
  @@map("nexus_messages")
}

// =============================================================================
// AGENT - Agent configuration (separate from Entity identity)
// =============================================================================

model Agent {
  id          String   @id @default(uuid()) @db.Uuid
  name        String   @unique
  description String?
  configJson  Json     @map("config_json") @db.JsonB
  configHash  String?  @map("config_hash") // For deduplication
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt   DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  entity Entity?
  runs   Run[]

  @@index([createdAt])
  @@map("agents")
}

// =============================================================================
// RUN - One execution of an Agent Entity in a Nexus
// =============================================================================

model Run {
  id            String    @id @default(uuid()) @db.Uuid
  nexusId       String    @map("nexus_id") @db.Uuid
  agentEntityId String    @map("agent_entity_id") @db.Uuid
  agentId       String    @map("agent_id") @db.Uuid
  triggeredById String?   @map("triggered_by_id") @db.Uuid // Entity that triggered this run
  parentRunId   String?   @map("parent_run_id") @db.Uuid   // For cross-nexus runs
  status        RunStatus
  startedAt     DateTime? @map("started_at") @db.Timestamptz(6)
  completedAt   DateTime? @map("completed_at") @db.Timestamptz(6)
  errorMessage  String?   @map("error_message")
  metadata      Json?     @db.JsonB
  createdAt     DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt     DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)

  nexus       Nexus  @relation(fields: [nexusId], references: [id])
  agentEntity Entity @relation(fields: [agentEntityId], references: [id])
  agent       Agent  @relation(fields: [agentId], references: [id])
  parentRun   Run?   @relation("RunHierarchy", fields: [parentRunId], references: [id])
  childRuns   Run[]  @relation("RunHierarchy")

  events       RunEvent[]
  toolCalls    ToolCall[]
  toolResults  ToolResult[]
  messages     NexusMessage[]

  @@index([nexusId, createdAt])
  @@index([agentEntityId, createdAt])
  @@index([status, updatedAt])
  @@index([parentRunId])
  @@map("runs")
}

// =============================================================================
// RUN EVENTS - Streaming events within a Run (Steps, deltas, etc.)
// =============================================================================

model RunEvent {
  id        String   @id @default(uuid()) @db.Uuid
  runId     String   @map("run_id") @db.Uuid
  seq       BigInt
  type      String   // text.delta, tool.call, tool.result, step.start, step.end, etc.
  payload   Json     @db.JsonB
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  run Run @relation(fields: [runId], references: [id], onDelete: Cascade)

  @@unique([runId, seq])
  @@index([runId, createdAt])
  @@map("run_events")
}

// =============================================================================
// TOOL CALLS & RESULTS
// =============================================================================

model ToolCall {
  id              String              @id @default(uuid()) @db.Uuid
  runId           String              @map("run_id") @db.Uuid
  seq             BigInt
  callId          String              @map("call_id")
  toolName        String              @map("tool_name")
  args            Json                @db.JsonB
  executionTarget ToolExecutionTarget @map("execution_target")
  targetClientId  String?             @map("target_client_id") @db.Uuid
  status          ToolCallStatus
  requestedAt     DateTime            @default(now()) @map("requested_at") @db.Timestamptz(6)
  completedAt     DateTime?           @map("completed_at") @db.Timestamptz(6)
  errorMessage    String?             @map("error_message")

  run          Run      @relation(fields: [runId], references: [id], onDelete: Cascade)
  targetClient Client?  @relation(fields: [targetClientId], references: [id])
  result       ToolResult?

  @@unique([runId, callId])
  @@index([runId, seq])
  @@index([targetClientId, status])
  @@map("tool_calls")
}

model ToolResult {
  id        String           @id @default(uuid()) @db.Uuid
  runId     String           @map("run_id") @db.Uuid
  callId    String           @map("call_id")
  result    Json             @db.JsonB
  source    ToolResultSource
  clientId  String?          @map("client_id") @db.Uuid
  createdAt DateTime         @default(now()) @map("created_at") @db.Timestamptz(6)

  run      Run      @relation(fields: [runId], references: [id], onDelete: Cascade)
  toolCall ToolCall @relation(fields: [runId, callId], references: [runId, callId])
  client   Client?  @relation(fields: [clientId], references: [id])

  @@unique([runId, callId])
  @@index([runId, createdAt])
  @@map("tool_results")
}

// =============================================================================
// CLIENT - Connection points (web, mobile, node backend, etc.)
// =============================================================================

model Client {
  id           String    @id @default(uuid()) @db.Uuid
  entityId     String    @map("entity_id") @db.Uuid
  clientKey    String    @unique @map("client_key") // Stable ID from token
  clientType   String?   @map("client_type")        // web, mobile, node, device
  displayName  String?   @map("display_name")
  capabilities Json      @default(dbgenerated("'{}'::jsonb")) @db.JsonB
  createdAt    DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  lastSeenAt   DateTime? @map("last_seen_at") @db.Timestamptz(6)

  entity      Entity       @relation(fields: [entityId], references: [id], onDelete: Cascade)
  toolCalls   ToolCall[]
  toolResults ToolResult[]

  @@index([entityId])
  @@index([clientType])
  @@map("clients")
}

// =============================================================================
// MEMORY - Long-term agent memory (persists across Runs and Nexuses)
// =============================================================================

model Memory {
  id        String   @id @default(uuid()) @db.Uuid
  entityId  String   @map("entity_id") @db.Uuid // Agent Entity that owns this memory
  topic     String?  // Categorization key
  content   String   @db.Text
  metadata  Json?    @db.JsonB
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  entity Entity @relation(fields: [entityId], references: [id], onDelete: Cascade)

  @@index([entityId, topic])
  @@index([entityId, createdAt])
  @@map("memories")
}

// =============================================================================
// PLAN - Agent scheduled executions
// =============================================================================

model Plan {
  id           String     @id @default(uuid()) @db.Uuid
  entityId     String     @map("entity_id") @db.Uuid // Agent Entity
  name         String?
  schedule     String     // Cron expression or ISO timestamp
  instruction  String?    @db.Text // What to do when triggered
  targetNexusId String?   @map("target_nexus_id") @db.Uuid
  status       PlanStatus @default(active)
  lastRunAt    DateTime?  @map("last_run_at") @db.Timestamptz(6)
  nextRunAt    DateTime?  @map("next_run_at") @db.Timestamptz(6)
  createdAt    DateTime   @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt    DateTime   @updatedAt @map("updated_at") @db.Timestamptz(6)

  entity Entity @relation(fields: [entityId], references: [id], onDelete: Cascade)

  @@index([entityId, status])
  @@index([nextRunAt, status])
  @@map("plans")
}

// =============================================================================
// GOAL - Agent objectives (short-term and long-term)
// =============================================================================

model Goal {
  id          String   @id @default(uuid()) @db.Uuid
  entityId    String   @map("entity_id") @db.Uuid // Agent Entity
  description String   @db.Text
  priority    Int      @default(0)
  isLongTerm  Boolean  @default(false) @map("is_long_term")
  isCompleted Boolean  @default(false) @map("is_completed")
  metadata    Json?    @db.JsonB
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt   DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  entity Entity @relation(fields: [entityId], references: [id], onDelete: Cascade)

  @@index([entityId, isCompleted])
  @@index([entityId, priority])
  @@map("goals")
}
